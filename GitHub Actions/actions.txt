name: Deploy Message Center Agent to Microsoft 365

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Teams Toolkit CLI
      run: npm install -g @microsoft/teamsfx-cli

    - name: Set up Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Microsoft 365
      run: npx @microsoft/teamsfx-cli account login m365 --tenant ${{ secrets.M365_TENANT_ID }}

    - name: Provision App in Microsoft Entra
      run: |
        npx @microsoft/teamsfx-cli provision
        echo "Provisioning completed."

    - name: Deploy App to Microsoft Teams
      run: |
        npx @microsoft/teamsfx-cli deploy
        echo "Deployment completed."

    - name: Grant Admin Consent for API Permissions
      run: |
        az ad app permission admin-consent --id ${{ secrets.CLIENT_ID }}
        echo "Admin consent granted."

    - name: Verify Deployment
      run: |
        npx @microsoft/teamsfx-cli validate
        echo "Validation completed."