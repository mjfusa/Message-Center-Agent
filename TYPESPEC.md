# TypeSpec-Based Agent Configuration

This repository has been converted to use TypeSpec for defining the M365 Copilot declarative agent configuration. TypeSpec provides a strongly-typed, maintainable way to define agents, their actions, and API specifications.

## Overview

TypeSpec is a domain-specific language for defining APIs and agent configurations. The TypeSpec compiler automatically generates all necessary JSON configuration files from the `main.tsp` source file.

## Key Files

### Source Files (Maintained)
- **`main.tsp`**: The primary TypeSpec definition file containing:
  - Agent metadata (name, description)
  - Conversation starters
  - Instructions (referenced from `appPackage/instructions.md`)
  - API action definitions for Message Center and Roadmap APIs
  - Authentication configuration (OAuth for Message Center, none for Roadmap)
  - Request/response models

- **`tspconfig.yaml`**: TypeSpec compiler configuration
  - Specifies which emitters to use
  - Configures output directories
  - References the M365 Copilot and OpenAPI3 emitters

- **`package.json`**: NPM package configuration with TypeSpec dependencies

### Generated Files (Auto-Generated)
The following files are automatically generated by TypeSpec and should **NOT** be edited directly:

- `appPackage/declarative-agent`: Declarative agent manifest
- `appPackage/apiSpecificationFile/MessageCenterAgent.MessageCenterAPI-openapi.json`: Message Center OpenAPI spec
- `appPackage/apiSpecificationFile/MessageCenterAgent.RoadmapAPI-openapi.json`: Roadmap OpenAPI spec

**Note**: These generated files are listed in `.gitignore` as they should be regenerated from source.

### Plugin Manifest Files (Manually Maintained)
The following plugin manifest files reference the TypeSpec-generated OpenAPI specs but are manually maintained:

- `appPackage/messagecenterapi-apiplugin.json`: Message Center API plugin manifest
- `appPackage/roadmapapi-apiplugin.json`: Roadmap API plugin manifest

**Note**: The M365 Copilot TypeSpec emitter doesn't currently auto-generate these plugin manifest files. They reference the TypeSpec-generated OpenAPI specs and configure response semantics (adaptive cards) for each API.

## Building

To compile the TypeSpec definitions and generate all configuration files:

```bash
npm run build
```

This will:
1. Clean any previous build artifacts
2. Compile `main.tsp` using the TypeSpec compiler
3. Generate the declarative agent manifest
4. Generate OpenAPI specifications for both APIs
5. **Merge examples** from `roadmap-openapi.json` into the TypeSpec-generated Roadmap API spec
6. Generate plugin manifests (currently manual, future: automated)

## Development Workflow

### Making Changes

1. **Edit `main.tsp`** to modify:
   - Agent name, description, or instructions
   - Conversation starters
   - API endpoints and operations
   - Request/response models
   - Authentication configuration

2. **Edit `appPackage/instructions.md`** to modify agent behavior instructions

3. **Build** to regenerate configuration files:
   ```bash
   npm run build
   ```

4. **Test** using the M365 Agents Toolkit:
   ```bash
   atk provision --env production
   ```

### File Watching

For active development, you can use watch mode:

```bash
npm run watch
```

This will automatically recompile when `main.tsp` is modified.

## Migration from JSON

This agent was previously configured using manually-maintained JSON files:
- `appPackage/declarativeAgent.json` (old)
- `appPackage/ai-plugin.json` (old)
- `appPackage/apiSpecificationFile/openapi.json` (old)
- `appPackage/apiSpecificationFile/roadmap-openapi.json` (old)

These files are now **deprecated** and should not be modified. All configuration changes should be made in `main.tsp`.

## TypeSpec Benefits

1. **Single Source of Truth**: All agent configuration in one file
2. **Type Safety**: Compile-time validation of models and operations
3. **Maintainability**: Easier to understand and modify than multiple JSON files
4. **Consistency**: Generated files are always in sync
5. **Documentation**: TypeSpec includes inline documentation
6. **Validation**: Compiler catches errors before deployment

## Resources

- [TypeSpec Documentation](https://typespec.io/)
- [M365 Copilot TypeSpec Guide](https://learn.microsoft.com/en-us/microsoft-365-copilot/extensibility/build-declarative-agents-typespec)
- [M365 Agents Toolkit](https://learn.microsoft.com/en-us/microsoft-365-copilot/extensibility/build-declarative-agents)

## Example Merging Workaround

### The Problem
Due to a known bug in TypeSpec, `@example` decorators defined in `main.tsp` are not emitted in the generated OpenAPI JSON files. This means parameter examples, response examples, and operation-level examples are lost during compilation.

### The Solution
Two post-processing PowerShell scripts automatically merge examples from handcrafted OpenAPI files into the TypeSpec-generated outputs after compilation:

1. **`scripts/Merge-MessageCenterExamples.ps1`**: Merges examples from `openapi.json` into `MessageCenterAgent.MessageCenterAPI-openapi.json`
2. **`scripts/Merge-RoadmapExamples.ps1`**: Merges examples from `roadmap-openapi.json` into `MessageCenterAgent.RoadmapAPI-openapi.json`

**What gets merged for Message Center API:**
- **Parameter examples**: 45 examples total
  - `$top`: 2 examples (count-only, pagination)
  - `$filter`: 43 examples (simple filters, compound filters, temporal queries)

**What gets merged for Roadmap API:**
- **Parameter examples**: 16 examples total
  - `$filter`: 9 examples (ID lookups, date filters, complex queries)
  - `$orderby`: 4 examples (sorting variations)
  - `$top`: 3 examples (default, large, max)
- **Response examples**: 2 examples showing typical API responses
- **Operation examples** (`x-ms-examples`): 3 complete request/response examples

### How It Works

1. TypeSpec compiles `main.tsp` â†’ generates both OpenAPI files (without examples)
2. Scripts read examples from source files:
   - `openapi.json` for Message Center API examples
   - `roadmap-openapi.json` for Roadmap API examples
3. Scripts merge examples into TypeSpec-generated files
4. Result: Complete OpenAPI specs with both TypeSpec-generated schemas AND handcrafted examples

### Maintaining Examples

**For Message Center API examples:**
1. Edit `appPackage/apiSpecificationFile/openapi.json`
2. Add/modify examples in parameter definitions
3. Run `npm run build` to merge examples

**For Roadmap API examples:**
1. Edit `appPackage/apiSpecificationFile/roadmap-openapi.json` 
2. Add/modify examples in:
   - `components/parameters/*/examples` for parameter examples
   - `paths/*/get/responses/200/content/application/json/examples` for response examples
   - `x-ms-examples` at the root level for operation examples
3. Run `npm run build` to merge examples

### Script Details

**Locations**: 
- `scripts/Merge-MessageCenterExamples.ps1` (Message Center API)
- `scripts/Merge-RoadmapExamples.ps1` (Roadmap API)

**Integration**: Both scripts run automatically after TypeSpec compilation via the `build` script in `package.json`

**Safety Features**:
- Creates backups before modifying generated files
- Validates JSON structure
- Provides detailed merge reports
- Exits gracefully if target files don't exist

**Output**: The scripts report exactly what was merged:

*Message Center API:*
```
âœ… Successfully merged examples!

Merged content:
    - $top (2 examples)
    - $filter (43 examples)

ðŸ“Š Total: 45 examples across 2 parameters
```

*Roadmap API:*
```
âœ… Successfully merged examples!

Merged content:
    - $filter (9 examples)
    - $orderby (4 examples)
    - $top (3 examples)
    - Response examples (2 examples)
    - x-ms-examples (3 examples)
```

## Troubleshooting

### Build Errors

If you encounter build errors:

1. Check that all TypeSpec dependencies are installed:
   ```bash
   npm install
   ```

2. Verify `tspconfig.yaml` has correct paths

3. Check `main.tsp` for syntax errors

4. Ensure PowerShell is available (required for example merging)

### Version Warnings

You may see warnings about incompatible library versions. This is expected as the M365 Copilot emitter uses a specific version of `@typespec/http`. These warnings do not affect functionality.

### Example Merge Issues

If examples are not appearing in the generated files:

1. Verify source files exist and contain examples:
   - `openapi.json` for Message Center API
   - `roadmap-openapi.json` for Roadmap API
2. Check that the merge scripts ran successfully (look for success messages)
3. Check the backup files (`.backup` suffix) to compare before/after
4. Run the merge scripts manually:
   - `.\scripts\Merge-MessageCenterExamples.ps1`
   - `.\scripts\Merge-RoadmapExamples.ps1`

## Future Enhancements

- Automate plugin manifest generation fully within TypeSpec
- Add CI/CD integration to validate TypeSpec on commits
- Add pre-commit hooks to ensure files are generated before commit
