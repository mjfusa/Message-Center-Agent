# TypeSpec-Based Agent Configuration

This repository has been converted to use TypeSpec for defining the M365 Copilot declarative agent configuration. TypeSpec provides a strongly-typed, maintainable way to define agents, their actions, and API specifications.

## Overview

TypeSpec is a domain-specific language for defining APIs and agent configurations. The TypeSpec compiler automatically generates all necessary JSON configuration files from the `main.tsp` source file.

## Key Files

### Source Files (Maintained)
- **`main.tsp`**: The primary TypeSpec definition file containing:
  - Agent metadata (name, description)
  - Conversation starters
  - Instructions (referenced from `appPackage/instructions.md`)
  - API action definitions for Message Center and Roadmap APIs
  - Authentication configuration (OAuth for Message Center, none for Roadmap)
  - Request/response models

- **`tspconfig.yaml`**: TypeSpec compiler configuration
  - Specifies which emitters to use
  - Configures output directories
  - References the M365 Copilot and OpenAPI3 emitters

- **`package.json`**: NPM package configuration with TypeSpec dependencies

### Generated Files (Auto-Generated)
The following files are automatically generated by TypeSpec and should **NOT** be edited directly:

- `appPackage/declarative-agent`: Declarative agent manifest
- `appPackage/apiSpecificationFile/MessageCenterAgent.MessageCenterAPI-openapi.json`: Message Center OpenAPI spec
- `appPackage/apiSpecificationFile/MessageCenterAgent.RoadmapAPI-openapi.json`: Roadmap OpenAPI spec

**Note**: These generated files are listed in `.gitignore` as they should be regenerated from source.

### Plugin Manifest Files (Manually Maintained)
The following plugin manifest files reference the TypeSpec-generated OpenAPI specs but are manually maintained:

- `appPackage/messagecenterapi-apiplugin.json`: Message Center API plugin manifest
- `appPackage/roadmapapi-apiplugin.json`: Roadmap API plugin manifest

**Note**: The M365 Copilot TypeSpec emitter doesn't currently auto-generate these plugin manifest files. They reference the TypeSpec-generated OpenAPI specs and configure response semantics (adaptive cards) for each API.

## Building

To compile the TypeSpec definitions and generate all configuration files:

```bash
npm run build
```

This will:
1. Clean any previous build artifacts
2. Compile `main.tsp` using the TypeSpec compiler
3. Generate the declarative agent manifest
4. Generate OpenAPI specifications for both APIs
5. Generate plugin manifests (currently manual, future: automated)

## Development Workflow

### Making Changes

1. **Edit `main.tsp`** to modify:
   - Agent name, description, or instructions
   - Conversation starters
   - API endpoints and operations
   - Request/response models
   - Authentication configuration

2. **Edit `appPackage/instructions.md`** to modify agent behavior instructions

3. **Build** to regenerate configuration files:
   ```bash
   npm run build
   ```

4. **Test** using the M365 Agents Toolkit:
   ```bash
   atk provision --env production
   ```

### File Watching

For active development, you can use watch mode:

```bash
npm run watch
```

This will automatically recompile when `main.tsp` is modified.

## Migration from JSON

This agent was previously configured using manually-maintained JSON files:
- `appPackage/declarativeAgent.json` (old)
- `appPackage/ai-plugin.json` (old)
- `appPackage/apiSpecificationFile/openapi.json` (old)
- `appPackage/apiSpecificationFile/roadmap-openapi.json` (old)

These files are now **deprecated** and should not be modified. All configuration changes should be made in `main.tsp`.

## TypeSpec Benefits

1. **Single Source of Truth**: All agent configuration in one file
2. **Type Safety**: Compile-time validation of models and operations
3. **Maintainability**: Easier to understand and modify than multiple JSON files
4. **Consistency**: Generated files are always in sync
5. **Documentation**: TypeSpec includes inline documentation
6. **Validation**: Compiler catches errors before deployment

## Resources

- [TypeSpec Documentation](https://typespec.io/)
- [M365 Copilot TypeSpec Guide](https://learn.microsoft.com/en-us/microsoft-365-copilot/extensibility/build-declarative-agents-typespec)
- [M365 Agents Toolkit](https://learn.microsoft.com/en-us/microsoft-365-copilot/extensibility/build-declarative-agents)

## Troubleshooting

### Build Errors

If you encounter build errors:

1. Check that all TypeSpec dependencies are installed:
   ```bash
   npm install
   ```

2. Verify `tspconfig.yaml` has correct paths

3. Check `main.tsp` for syntax errors

### Version Warnings

You may see warnings about incompatible library versions. This is expected as the M365 Copilot emitter uses a specific version of `@typespec/http`. These warnings do not affect functionality.

## Future Enhancements

- Automate plugin manifest generation fully within TypeSpec
- Add CI/CD integration to validate TypeSpec on commits
- Add pre-commit hooks to ensure files are generated before commit
